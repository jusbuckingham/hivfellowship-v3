#!/bin/sh
set -e

# Always run from repo root
cd "$(git rev-parse --show-toplevel)"

echo "pre-commit: converting staged images to WebPâ€¦"

# Helper: run sed -i cross-platform (GNU vs macOS/BSD)
sed_inplace () {
  # $1 = pattern; $2 = file
  if sed --version >/dev/null 2>&1; then
    # GNU sed
    sed -i "$1" "$2"
  else
    # macOS/BSD sed requires a backup suffix (empty string)
    sed -i '' "$1" "$2"
  fi
}

# Convert only STAGED images in public/
git diff --cached --name-only --diff-filter=ACM | grep -Ei '^public/.*\.(png|jpe?g)$' | while read -r src; do
  [ -f "$src" ] || continue

  base_no_ext=${src%.*}
  ext=${src##*.}
  dst="${base_no_ext}.webp"

  case "$ext" in
    png|PNG)
      cwebp -lossless -m 6 "$src" -o "$dst" >/dev/null
      ;;
    jpg|JPG|jpeg|JPEG)
      cwebp -q 80 -m 6 "$src" -o "$dst" >/dev/null
      ;;
    *)
      continue
      ;;
  esac

  # Replace original with .webp (index + filesystem)
  git rm -q --cached -- "$src" 2>/dev/null || true
  rm -f -- "$src"
  git add -- "$dst"

  old_name=$(basename "$src")
  new_name=$(basename "$dst")

  # Update references in tracked files
  for d in app components pages data; do
    git ls-files "$d" 2>/dev/null | while read -r f; do
      [ -f "$f" ] || continue
      if grep -Iq . "$f" && grep -q "$old_name" "$f"; then
        sed_inplace "s|$old_name|$new_name|g" "$f"
        git add -- "$f"
      fi
    done
  done
done

# Ensure changes are staged
git add -A
exit 0
